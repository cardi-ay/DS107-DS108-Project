import os
import time
import pandas as pd
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.chrome.options import Options
from selenium.common.exceptions import NoSuchElementException

# ===== 1. Cáº¥u hÃ¬nh thÆ° má»¥c táº£i & Chrome =====
download_folder = os.path.abspath("downloads")
os.makedirs(download_folder, exist_ok=True)

chrome_options = Options()
chrome_options.add_experimental_option("prefs", {
    "download.default_directory": download_folder,
    "plugins.always_open_pdf_externally": True,
    "download.prompt_for_download": False,
    "download.directory_upgrade": True,
    "safebrowsing.enabled": True
})

driver = webdriver.Chrome(options=chrome_options)

# ===== 2. Truy cáº­p trang web =====
url = "https://nghiepvuy.medinet.gov.vn/ket-qua-dich-vu-cong-vb4539.aspx"
driver.get(url)
time.sleep(3)

file_data = []
current_page = 1
target_end_page = 63

# ===== 3. Duyá»‡t tá»«ng trang =====
while current_page <= target_end_page:
    print(f"\nðŸ“„ Äang xá»­ lÃ½ trang {current_page}...")

    try:
        table = driver.find_element(By.ID, "plcall_Documents1_grvmn")
        links = table.find_elements(By.TAG_NAME, "a")
        print(f"ðŸ”— TÃ¬m tháº¥y {len(links)} link trÃªn trang {current_page}")

        for link in links:
            file_url = link.get_attribute("href")
            if file_url and file_url.lower().endswith(".pdf"):
                file_name = file_url.split("/")[-1]
                file_path = os.path.join(download_folder, file_name)

                if not os.path.exists(file_path):
                    print(f"â¬‡ï¸ Äang táº£i: {file_name}")
                    try:
                        link.click()
                        time.sleep(4)  # Äá»£i Chrome táº£i PDF
                    except Exception as e:
                        print(f"âŒ Lá»—i khi click link: {e}")
                        continue
                else:
                    print(f"ðŸ“‚ ÄÃ£ tá»“n táº¡i: {file_name}")

                file_data.append({
                    "Trang": current_page,
                    "TÃªn file": file_name,
                    "ÄÆ°á»ng dáº«n": file_url,
                    "Vá»‹ trÃ­ lÆ°u": file_path
                })

    except NoSuchElementException:
        print("âŒ KhÃ´ng tÃ¬m tháº¥y báº£ng dá»¯ liá»‡u.")
        break

    # ===== 4. Chuyá»ƒn trang =====
    try:
        pagination_links = driver.find_elements(By.TAG_NAME, "a")
        moved = False

        for btn in pagination_links:
            if btn.text.strip() == str(current_page + 1):
                print(f"âž¡ï¸ Chuyá»ƒn sang trang {current_page + 1}")
                btn.click()
                current_page += 1
                time.sleep(3)
                moved = True
                break

        if not moved:
            ellipsis_buttons = [btn for btn in pagination_links if btn.text.strip() == "..."]
            if ellipsis_buttons:
                print("ðŸ” Má»Ÿ cá»¥m phÃ¢n trang káº¿ tiáº¿p (dáº¥u ... cuá»‘i)")
                ellipsis_buttons[-1].click()
                time.sleep(2)
            else:
                print("âœ… ÄÃ£ duyá»‡t háº¿t cÃ¡c trang.")
                break

    except Exception as e:
        print(f"âŒ Lá»—i khi chuyá»ƒn trang: {e}")
        break

# ===== 5. Ghi file CSV =====
df = pd.DataFrame(file_data)
df.to_csv("file_links.csv", index=False, encoding='utf-8-sig')

driver.quit()
print("\nðŸŽ‰ HOÃ€N Táº¤T! ÄÃ£ táº£i toÃ n bá»™ PDF vÃ  lÆ°u thÃ´ng tin vÃ o file_links.csv")
